<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Dashboard v4</title>
    <style>
        :root {
            --bg: #121212;
            --text: #e0e0e0;
            --accent: #bb86fc;
            --card-bg: #1e1e1e;
            --button-bg: #2d2d2d;
            --button-hover: #FF4F00;
            --input-bg: #2d2d2d;
            --border: #3d3d3d;
        }

        .theme-dark { --bg: #121212; --text: #e0e0e0; --accent: #FF4F00; --card-bg: #1e1e1e; --button-bg: #2d2d2d; --button-hover: #FF4F00; --input-bg: #2d2d2d; --border: #3d3d3d; }
        .theme-light { --bg: #f5f5f5; --text: #212121; --accent: #6200ee; --card-bg: #ffffff; --button-bg: #e0e0e0; --button-hover: #6200ee; --input-bg: #ffffff; --border: #bdbdbd; }
        .theme-ocean { --bg: #0d1b2a; --text: #e0e1dd; --accent: #4cc9f0; --card-bg: #1b263b; --button-bg: #415a77; --button-hover: #4cc9f0; --input-bg: #1b263b; --border: #778da9; }
        .theme-forest { --bg: #1a2f1a; --text: #e8f5e9; --accent: #81c784; --card-bg: #2e4d2e; --button-bg: #3d6b3d; --button-hover: #81c784; --input-bg: #2e4d2e; --border: #4caf50; }
        .theme-sunset { --bg: #2d1b2d; --text: #fff0f0; --accent: #ff7e5f; --card-bg: #3d2b3d; --button-bg: #4d3b4d; --button-hover: #feb47b; --input-bg: #3d2b3d; --border: #ff7e5f; }

        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        header { margin-top: 40px; position: relative; width: 90%; max-width: 1400px; text-align: center; }
        .settings-btn { position: absolute; top: 0; right: 0; background: var(--button-bg); border: none; color: var(--text); padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: all 0.15s ease; }
        .settings-btn:hover { background: var(--accent); color: #121212; }
        #clock { font-size: 4.5rem; font-weight: bold; margin: 20px 0; letter-spacing: 2px; }
        #date { font-size: 1.6rem; margin-bottom: 30px; opacity: 0.9; }
        .search-container { margin-bottom: 30px; }
        #search-box { width: 100%; max-width: 600px; padding: 15px 20px; font-size: 1.1rem; background: var(--input-bg); border: 2px solid var(--border); border-radius: 25px; color: var(--text); outline: none; }
        #search-box:focus { border-color: var(--accent); }

        .container { display: grid; grid-template-columns: 300px 1fr 300px; gap: 30px; max-width: 1400px; width: 95%; margin-bottom: 60px; }
        
        .panel { display: flex; flex-direction: column; gap: 20px; }
        .group-card { background: var(--card-bg); border-radius: 12px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .group-title { color: var(--accent); font-size: 1.1rem; font-weight: bold; margin-bottom: 12px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        .links-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .link-button { aspect-ratio: 1/1; background: var(--button-bg); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; color: var(--text); padding: 10px; transition: 0.2s; }
        .link-button:hover { background: var(--button-hover); color: #121212; transform: translateY(-3px); }
        .link-icon { width: 24px; height: 24px; margin-bottom: 5px; object-fit: contain; }

        #weather-widget { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); text-align: center; }
        .weather-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .weather-tab { padding: 5px 10px; background: var(--button-bg); border-radius: 5px; cursor: pointer; font-size: 0.8rem; transition: 0.3s; }
        .weather-tab.active { background: var(--accent); color: #121212; }
        #weather-icon { width: 80px; height: 80px; margin: 0 auto; }
        #weather-temp { font-size: 2.5rem; font-weight: bold; }

        #calendar { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; }
        th { color: var(--accent); padding: 5px; font-size: 0.9rem; }
        td { padding: 10px; cursor: pointer; transition: 0.2s; border-radius: 5px; text-align: center; }
        td:hover:not(.empty) { background: var(--button-bg); }
        .today { background: var(--accent); color: #121212; font-weight: bold; }

        #tasks-widget { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); margin-top: 20px; }
        .task-item { display: flex; align-items: center; gap: 10px; padding: 8px; background: var(--button-bg); border-radius: 8px; margin-bottom: 5px; text-align: left; }
        .task-item.completed span { text-decoration: line-through; opacity: 0.6; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 12px; width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--accent); }
        .form-group input, .form-group select { width: 100%; padding: 8px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 5px; color: var(--text); }

        .link-edit-row { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: center; }
        .btn-danger { background: #ff6b6b; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .btn-add { background: var(--accent); color: #121212; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px; }

        .theme-card { border: 1px solid var(--border); padding: 10px; border-radius: 8px; display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; background: rgba(255,255,255,0.02); margin-bottom: 10px; }
        .theme-previews { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
        .color-swatch { width: 28px; height: 20px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.2); }

        @media (max-width: 1100px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body class="theme-dark">
    <header>
        <button class="settings-btn" id="settings-btn">⚙️ Settings</button>
        <div id="clock"></div>
        <div id="date"></div>
        <div class="search-container">
            <input type="search" id="search-box" placeholder="Search Google..." />
        </div>
    </header>

    <div class="container">
        <div class="panel" id="left-panel"></div>
        
        <div class="center-column">
            <div id="weather-widget">
                <div class="weather-tabs" id="weather-tabs"></div>
                <h2 id="weather-location">Loading...</h2>
                <img id="weather-icon" src="" alt="" />
                <div id="weather-temp">--°F</div>
                <div id="weather-desc">--</div>
                <div class="weather-details" id="weather-details"></div>
            </div>

            <div id="calendar" style="margin-top: 20px;">
                <div class="calendar-header">
                    <button class="weather-tab" id="prev-month">◀</button>
                    <h2 id="month-year" style="margin:0; color:var(--accent)"></h2>
                    <button class="weather-tab" id="next-month">▶</button>
                </div>
                <table id="calendar-table">
                    <thead><tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr></thead>
                    <tbody id="calendar-body"></tbody>
                </table>
            </div>

            <div id="tasks-widget">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
                    <h2 style="color:var(--accent); margin:0">Tasks</h2>
                    <select id="task-mode" class="weather-tab" style="border:none; outline:none">
                        <option value="local">Local Tasks</option>
                        <option value="google">Google Tasks</option>
                    </select>
                </div>
                
                <div id="local-tasks-ui">
                    <div style="display:flex; gap:10px; margin-bottom:15px">
                        <input type="text" id="task-input" placeholder="Add task..." style="flex:1; padding:8px; border-radius:5px; border:1px solid var(--border); background:var(--input-bg); color:var(--text)" />
                        <button class="weather-tab" id="add-task-btn">Add</button>
                    </div>
                    <div id="tasks-list"></div>
                </div>

                <div id="google-tasks-ui" style="display:none; height: 400px; border-radius: 8px; overflow: hidden; border: 1px solid var(--border);">
                    <iframe id="tasks-iframe" src="https://tasks.google.com/embed/?origin=https://calendar.google.com&fullWidth=1" style="width:100%; height:100%; border:none;"></iframe>
                </div>
            </div>
        </div>

        <div class="panel" id="right-panel"></div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--accent); margin-top:0">Settings</h2>
            
            <div class="form-group">
                <label>Theme</label>
                <!-- will be populated dynamically -->
                <select id="theme-select"></select>
            </div>

            <div class="form-group">
                <label>Manage Themes</label>
                <div id="themes-config"></div>
                <div style="display:flex; gap:10px; margin-top:8px;">
                    <button class="btn-add" id="add-theme-btn">+ Add Theme</button>
                    <button id="reset-themes-btn" class="weather-tab">Reset Defaults</button>
                </div>
                <small style="display:block; margin-top:8px; color:var(--text); opacity:0.8">Edit colors for each theme, set the active theme using the selector above, and delete themes you don't want. At least one theme must remain.</small>
            </div>

            <!-- IMPORT / EXPORT SETTINGS -->
            <div class="form-group">
                <label>Import / Export Settings</label>
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                    <button class="weather-tab" id="export-settings-btn">Export Settings</button>
                    <button class="weather-tab" id="import-settings-btn">Import Settings</button>
                    <input type="file" id="import-file-input" accept=".json,application/json" style="display:none" />
                </div>
                <small style="display:block; margin-top:8px; color:var(--text); opacity:0.8">Export saves your configuration (themes, groups, weather locations, tasks). Import will replace current settings. A preview will be applied immediately.</small>
            </div>

            <div class="form-group">
                <label>Weather Locations (Up to 3)</label>
                <div id="weather-configs"></div>
            </div>

            <div class="form-group">
                <label>Link Groups</label>
                <div id="groups-config"></div>
                <button class="btn-add" id="add-group-btn">+ Add Group</button>
            </div>

            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px">
                <button class="weather-tab" id="cancel-settings">Cancel</button>
                <button class="weather-tab active" id="save-settings">Save All</button>
            </div>
        </div>
    </div>

    <script>
        // Default themes (kept consistent with static CSS defaults)
        const DEFAULT_THEMES = [
            {
                id: 'dark',
                name: 'Dark',
                vars: { '--bg': '#121212', '--text': '#e0e0e0', '--accent': '#FF4F00', '--card-bg': '#1e1e1e', '--button-bg': '#2d2d2d', '--button-hover': '#FF4F00', '--input-bg': '#2d2d2d', '--border': '#3d3d3d' }
            },
            {
                id: 'light',
                name: 'Light',
                vars: { '--bg': '#f5f5f5', '--text': '#212121', '--accent': '#6200ee', '--card-bg': '#ffffff', '--button-bg': '#e0e0e0', '--button-hover': '#6200ee', '--input-bg': '#ffffff', '--border': '#bdbdbd' }
            },
            {
                id: 'ocean',
                name: 'Ocean',
                vars: { '--bg': '#0d1b2a', '--text': '#e0e1dd', '--accent': '#4cc9f0', '--card-bg': '#1b263b', '--button-bg': '#415a77', '--button-hover': '#4cc9f0', '--input-bg': '#1b263b', '--border': '#778da9' }
            },
            {
                id: 'forest',
                name: 'Forest',
                vars: { '--bg': '#1a2f1a', '--text': '#e8f5e9', '--accent': '#81c784', '--card-bg': '#2e4d2e', '--button-bg': '#3d6b3d', '--button-hover': '#81c784', '--input-bg': '#2e4d2e', '--border': '#4caf50' }
            },
            {
                id: 'sunset',
                name: 'Sunset',
                vars: { '--bg': '#2d1b2d', '--text': '#fff0f0', '--accent': '#ff7e5f', '--card-bg': '#3d2b3d', '--button-bg': '#4d3b4d', '--button-hover': '#feb47b', '--input-bg': '#3d2b3d', '--border': '#ff7e5f' }
            }
        ];

        let config = {
            theme: 'dark', // active theme id
            themes: JSON.parse(JSON.stringify(DEFAULT_THEMES)), // list of editable themes
            weatherLocations: [
                { name: 'Hanover, PA', lat: 39.8007, lon: -76.9830 },
                { name: 'New York, NY', lat: 40.7128, lon: -74.0060 },
                { name: 'London, UK', lat: 51.5074, lon: -0.1278 }
            ],
            activeWeatherIdx: 0,
            groups: [
                { id: 'g1', title: 'Social', panel: 'left', links: [
                    { name: 'Reddit', url: 'https://reddit.com', icon: 'https://www.google.com/s2/favicons?domain=reddit.com&sz=64' },
                    { name: 'X', url: 'https://twitter.com', icon: 'https://www.google.com/s2/favicons?domain=twitter.com&sz=64' }
                ]},
                { id: 'g2', title: 'Work', panel: 'right', links: [
                    { name: 'GitHub', url: 'https://github.com', icon: 'https://www.google.com/s2/favicons?domain=github.com&sz=64' },
                    { name: 'Gmail', url: 'https://gmail.com', icon: 'https://www.google.com/s2/favicons?domain=gmail.com&sz=64' }
                ]}
            ]
        };

        let tasks = [];
        let currentCalDate = new Date();

        function loadData() {
            const savedConfig = localStorage.getItem('dash_v4_config');
            if (savedConfig) {
                try {
                    const parsed = JSON.parse(savedConfig);
                    // merge safely: ensure required properties exist
                    if (parsed.themes && Array.isArray(parsed.themes)) config.themes = parsed.themes;
                    if (parsed.theme) config.theme = parsed.theme;
                    if (parsed.weatherLocations) config.weatherLocations = parsed.weatherLocations;
                    if (typeof parsed.activeWeatherIdx === 'number') config.activeWeatherIdx = parsed.activeWeatherIdx;
                    if (parsed.groups) config.groups = parsed.groups;
                } catch (e) { console.error('Failed parsing config, using defaults', e); }
            }
            const savedTasks = localStorage.getItem('dash_v4_tasks');
            if (savedTasks) {
                try { tasks = JSON.parse(savedTasks); } catch (e) { tasks = []; }
            }
            // ensure at least one theme exists
            if (!config.themes || !config.themes.length) config.themes = JSON.parse(JSON.stringify(DEFAULT_THEMES));
            // if active theme not found, fallback to first
            if (!config.themes.find(t => t.id === config.theme)) config.theme = config.themes[0].id;
            applyTheme(config.theme);
        }

        function saveData() {
            localStorage.setItem('dash_v4_config', JSON.stringify(config));
            localStorage.setItem('dash_v4_tasks', JSON.stringify(tasks));
        }

        function applyTheme(themeId) {
            const theme = config.themes.find(t => t.id === themeId);
            if (!theme) return;
            // apply variables directly to :root so they override static CSS
            const root = document.documentElement;
            Object.entries(theme.vars).forEach(([k, v]) => root.style.setProperty(k, v));
            // update body class for compatibility / existing CSS (optional)
            document.body.className = `theme-${themeId}`;
            config.theme = themeId;
            // update theme-select UI if present
            const sel = document.getElementById('theme-select');
            if (sel) sel.value = themeId;
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('date').textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        async function fetchWeather() {
            const loc = config.weatherLocations[config.activeWeatherIdx];
            if (!loc) return;
            try {
                // Using open-meteo current_weather
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&current_weather=true&windspeed_unit=mph&temperature_unit=fahrenheit`);
                const data = await res.json();
                const cur = data.current_weather || {};
                document.getElementById('weather-location').textContent = loc.name;
                if (typeof cur.temperature === 'number') {
                    document.getElementById('weather-temp').textContent = `${Math.round(cur.temperature)}°F`;
                } else {
                    document.getElementById('weather-temp').textContent = `--°F`;
                }
                document.getElementById('weather-desc').textContent = getWeatherDesc(cur.weathercode);
                document.getElementById('weather-icon').src = getWeatherIcon(cur.weathercode);
                const wind = cur.windspeed ? `${Math.round(cur.windspeed)} mph` : '--';
                document.getElementById('weather-details').innerHTML = `Humidity: -- | Wind: ${wind}`;
            } catch (e) { console.error(e); }
        }

        function getWeatherDesc(code) {
            const codes = { 0: 'Clear', 1: 'Mainly Clear', 2: 'Partly Cloudy', 3: 'Overcast', 45: 'Fog', 48: 'Depositing rime fog', 51: 'Drizzle', 61: 'Rain', 71: 'Snow', 95: 'Thunderstorm' };
            return codes[code] || 'Cloudy';
        }

        function getWeatherIcon(code) {
            const icons = { 0: '01d', 1: '02d', 2: '03d', 3: '04d', 45: '50d', 48: '50d', 51: '09d', 61: '10d', 71: '13d', 95: '11d' };
            return `https://openweathermap.org/img/wn/${icons[code] || '03d'}@4x.png`;
        }

        function renderWeatherTabs() {
            const container = document.getElementById('weather-tabs');
            container.innerHTML = '';
            config.weatherLocations.forEach((loc, i) => {
                if (!loc.name) return;
                const tab = document.createElement('div');
                tab.className = `weather-tab ${i === config.activeWeatherIdx ? 'active' : ''}`;
                tab.textContent = loc.name.split(',')[0];
                tab.onclick = () => { config.activeWeatherIdx = i; renderWeatherTabs(); fetchWeather(); saveData(); };
                container.appendChild(tab);
            });
        }

        function renderPanels() {
            const left = document.getElementById('left-panel');
            const right = document.getElementById('right-panel');
            left.innerHTML = ''; right.innerHTML = '';

            config.groups.forEach(group => {
                const card = document.createElement('div');
                card.className = 'group-card';
                card.innerHTML = `<div class="group-title">${group.title}</div><div class="links-grid"></div>`;
                const grid = card.querySelector('.links-grid');
                group.links.forEach(link => {
                    const a = document.createElement('a');
                    a.href = link.url; a.target = '_blank'; a.className = 'link-button';
                    const icon = link.icon && link.icon.trim() ? link.icon : `https://www.google.com/s2/favicons?sz=64&domain=${(new URL(link.url)).hostname}`;
                    a.innerHTML = `<img src="${icon}" class="link-icon" alt=""><span>${link.name}</span>`;
                    grid.appendChild(a);
                });
                (group.panel === 'left' ? left : right).appendChild(card);
            });
        }

        function renderCalendar() {
            const year = currentCalDate.getFullYear();
            const month = currentCalDate.getMonth();
            document.getElementById('month-year').textContent = currentCalDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const body = document.getElementById('calendar-body');
            body.innerHTML = '';
            let day = 1;
            for (let i = 0; i < 6; i++) {
                const row = document.createElement('tr');
                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement('td');
                    if (i === 0 && j < firstDay || day > daysInMonth) {
                        cell.className = 'empty';
                    } else {
                        cell.textContent = day;
                        const d = day;
                        cell.onclick = () => window.open(`https://calendar.google.com/calendar/u/0/r/day/${year}/${month+1}/${d}`, '_blank');
                        if (new Date().toDateString() === new Date(year, month, d).toDateString()) cell.className = 'today';
                        day++;
                    }
                    row.appendChild(cell);
                }
                body.appendChild(row);
                if (day > daysInMonth) break;
            }
        }

        function renderTasks() {
            const list = document.getElementById('tasks-list');
            list.innerHTML = '';
            tasks.forEach((task, i) => {
                const div = document.createElement('div');
                div.className = `task-item ${task.completed ? 'completed' : ''}`;
                div.innerHTML = `<input type="checkbox" ${task.completed ? 'checked' : ''}><span>${task.text}</span><button class="btn-danger" style="margin-left:auto; padding:2px 6px">×</button>`;
                div.querySelector('input').onchange = () => { tasks[i].completed = !tasks[i].completed; renderTasks(); saveData(); };
                div.querySelector('button').onclick = () => { tasks.splice(i, 1); renderTasks(); saveData(); };
                list.appendChild(div);
            });
        }

        // Settings UI: Themes
        function renderThemeControls() {
            const container = document.getElementById('themes-config');
            container.innerHTML = '';
            config.themes.forEach((theme, idx) => {
                const card = document.createElement('div');
                card.className = 'theme-card';
                // name + preview
                const left = document.createElement('div');
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.gap = '8px';
                row.style.alignItems = 'center';
                const nameInput = document.createElement('input');
                nameInput.value = theme.name || theme.id;
                nameInput.style.width = '40%';
                nameInput.className = 'theme-name';
                // previews
                const previews = document.createElement('div');
                previews.className = 'theme-previews';
                ['--bg','--text','--accent','--card-bg','--button-bg','--button-hover','--input-bg','--border'].forEach(v => {
                    const sw = document.createElement('div');
                    sw.className = 'color-swatch';
                    sw.style.background = theme.vars[v] || '#000';
                    previews.appendChild(sw);
                });
                row.appendChild(nameInput);
                row.appendChild(previews);
                left.appendChild(row);

                // color inputs area collapsed by default
                const colorsArea = document.createElement('div');
                colorsArea.style.marginTop = '8px';
                colorsArea.style.display = 'grid';
                colorsArea.style.gridTemplateColumns = 'repeat(2, 1fr)';
                colorsArea.style.gap = '6px';
                const varKeys = ['--bg','--text','--accent','--card-bg','--button-bg','--button-hover','--input-bg','--border'];
                varKeys.forEach(k => {
                    const fld = document.createElement('div');
                    fld.style.display = 'flex';
                    fld.style.gap = '6px';
                    fld.style.alignItems = 'center';
                    const label = document.createElement('label');
                    label.style.width = '90px';
                    label.style.color = 'var(--text)';
                    label.style.opacity = '0.9';
                    label.textContent = k.replace('--','');
                    const input = document.createElement('input');
                    input.type = 'color';
                    // ensure hex fallback if value is rgb or named color
                    const v = theme.vars[k] || '#000000';
                    input.value = toHex(v);
                    input.dataset.var = k;
                    input.className = 'theme-color';
                    input.style.width = '56px';
                    fld.appendChild(label);
                    fld.appendChild(input);
                    colorsArea.appendChild(fld);
                });
                left.appendChild(colorsArea);

                // controls on right
                const right = document.createElement('div');
                right.style.display = 'flex';
                right.style.flexDirection = 'column';
                right.style.gap = '8px';
                right.style.alignItems = 'flex-end';

                const applyBtn = document.createElement('button');
                applyBtn.className = 'weather-tab';
                applyBtn.textContent = (theme.id === config.theme) ? 'Active' : 'Apply';
                applyBtn.onclick = () => { applyTheme(theme.id); saveData(); renderThemeControls(); };

                const delBtn = document.createElement('button');
                delBtn.className = 'btn-danger';
                delBtn.textContent = 'Delete';
                delBtn.onclick = () => {
                    if (config.themes.length <= 1) {
                        alert('At least one theme must remain.');
                        return;
                    }
                    if (!confirm(`Delete theme "${theme.name}"?`)) return;
                    config.themes.splice(idx,1);
                    // if deleted theme was active, set new active
                    if (config.theme === theme.id) config.theme = config.themes[0].id;
                    renderThemeControls();
                };

                right.appendChild(applyBtn);
                right.appendChild(delBtn);

                card.appendChild(left);
                card.appendChild(right);
                container.appendChild(card);

                // events to update preview when name or color changed
                nameInput.oninput = (e) => { theme.name = e.target.value; renderThemeSelect(); saveData(); };
                colorsArea.querySelectorAll('.theme-color').forEach(inp => {
                    inp.oninput = (e) => {
                        const varName = e.target.dataset.var;
                        theme.vars[varName] = e.target.value;
                        // update preview square
                        const swIndex = varKeys.indexOf(varName);
                        if (swIndex >= 0) previews.children[swIndex].style.background = e.target.value;
                        // if this is active theme, apply live
                        if (config.theme === theme.id) applyTheme(theme.id);
                    };
                });
            });
        }

        function toHex(color) {
            // If already a hex return as-is. If rgb(...) convert to hex. Otherwise try to return the input or fallback.
            if (!color) return '#000000';
            color = color.trim();
            if (color.startsWith('#')) {
                if (color.length === 4) {
                    // expand shorthand #abc -> #aabbcc
                    return '#' + color.slice(1).split('').map(c => c + c).join('');
                }
                return color;
            }
            if (color.startsWith('rgb')) {
                const nums = color.match(/\d+/g).map(Number);
                const hex = nums.slice(0,3).map(n => n.toString(16).padStart(2,'0')).join('');
                return '#'+hex;
            }
            // named color fallback: create temporary element to compute
            const ctx = document.createElement('div');
            ctx.style.color = color;
            document.body.appendChild(ctx);
            const cs = getComputedStyle(ctx).color;
            document.body.removeChild(ctx);
            if (cs.startsWith('rgb')) {
                const nums = cs.match(/\d+/g).map(Number);
                const hex = nums.slice(0,3).map(n => n.toString(16).padStart(2,'0')).join('');
                return '#'+hex;
            }
            return '#000000';
        }

        function renderThemeSelect() {
            const sel = document.getElementById('theme-select');
            sel.innerHTML = '';
            config.themes.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = t.name || t.id;
                sel.appendChild(opt);
            });
            sel.value = config.theme;
        }

        function openSettings() {
            // populate theme-select and themes-config
            renderThemeSelect();
            renderThemeControls();

            // weather configs
            const weatherDiv = document.getElementById('weather-configs');
            weatherDiv.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const loc = config.weatherLocations[i] || { name: '', lat: 0, lon: 0 };
                const row = document.createElement('div');
                row.className = 'link-edit-row';
                row.innerHTML = `<input type="text" placeholder="City Name" value="${escapeHtml(loc.name)}" class="w-name">
                    <input type="number" placeholder="Lat" value="${loc.lat}" class="w-lat" step="any">
                    <input type="number" placeholder="Lon" value="${loc.lon}" class="w-lon" step="any">`;
                weatherDiv.appendChild(row);
            }

            // groups
            const groupsDiv = document.getElementById('groups-config');
            groupsDiv.innerHTML = '';
            config.groups.forEach((group, gi) => {
                const gDiv = document.createElement('div');
                gDiv.className = 'group-card';
                gDiv.style.marginBottom = '15px';
                gDiv.innerHTML = `
                    <div class="link-edit-row">
                        <input type="text" value="${escapeHtml(group.title)}" class="g-title" placeholder="Group Title">
                        <select class="g-panel"><option value="left">Left</option><option value="right">Right</option></select>
                        <button class="btn-danger del-group">Delete Group</button>
                    </div>
                    <div class="links-edit-list"></div>
                    <button class="btn-add add-link-btn" style="font-size:0.8rem">+ Add Link</button>
                `;
                const panelSel = gDiv.querySelector('.g-panel');
                panelSel.value = group.panel || 'left';
                const linksList = gDiv.querySelector('.links-edit-list');
                group.links.forEach((link, li) => {
                    const lRow = document.createElement('div');
                    lRow.className = 'link-edit-row';
                    lRow.innerHTML = `
                        <input type="text" value="${escapeHtml(link.name)}" class="l-name" placeholder="Name">
                        <input type="text" value="${escapeHtml(link.url)}" class="l-url" placeholder="URL">
                        <input type="text" value="${escapeHtml(link.icon || '')}" class="l-icon" placeholder="Icon URL">
                        <button class="btn-danger del-link">×</button>
                    `;
                    lRow.querySelector('.del-link').onclick = () => lRow.remove();
                    linksList.appendChild(lRow);
                });
                gDiv.querySelector('.add-link-btn').onclick = () => {
                    const lRow = document.createElement('div');
                    lRow.className = 'link-edit-row';
                    lRow.innerHTML = `<input type="text" class="l-name" placeholder="Name"><input type="text" class="l-url" placeholder="URL"><input type="text" class="l-icon" placeholder="Icon URL"><button class="btn-danger del-link">×</button>`;
                    lRow.querySelector('.del-link').onclick = () => lRow.remove();
                    linksList.appendChild(lRow);
                };
                gDiv.querySelector('.del-group').onclick = () => gDiv.remove();
                groupsDiv.appendChild(gDiv);
            });

            document.getElementById('settings-modal').classList.add('active');
        }

        function escapeHtml(s) {
            if (!s) return '';
            return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        async function saveSettings() {
            // theme selection
            const sel = document.getElementById('theme-select');
            if (sel) applyTheme(sel.value);

            // weather locations
            config.weatherLocations = [];
            document.querySelectorAll('#weather-configs .link-edit-row').forEach(row => {
                const name = row.querySelector('.w-name').value;
                const lat = parseFloat(row.querySelector('.w-lat').value) || 0;
                const lon = parseFloat(row.querySelector('.w-lon').value) || 0;
                if (name) config.weatherLocations.push({ name, lat, lon });
            });
            // limit to 3
            config.weatherLocations = config.weatherLocations.slice(0,3);

            // groups
            config.groups = [];
            document.querySelectorAll('#groups-config .group-card').forEach(gCard => {
                const title = gCard.querySelector('.g-title').value || 'Group';
                const panel = gCard.querySelector('.g-panel').value || 'left';
                const group = { title, panel, links: [] };
                gCard.querySelectorAll('.links-edit-list .link-edit-row').forEach(lRow => {
                    const name = lRow.querySelector('.l-name').value;
                    if (name) group.links.push({ name, url: lRow.querySelector('.l-url').value, icon: lRow.querySelector('.l-icon').value });
                });
                config.groups.push(group);
            });

            // themes: already edited live in config.themes via events in renderThemeControls
            // ensure ids are unique for new themes and sanitized
            config.themes = config.themes.map((t, i) => {
                if (!t.id) t.id = `theme_${Date.now()}_${i}`;
                return t;
            });

            applyTheme(config.theme);
            renderWeatherTabs();
            fetchWeather();
            renderPanels();
            renderCalendar();
            renderTasks();
            saveData();
            document.getElementById('settings-modal').classList.remove('active');
        }

        // Add new theme (based on current active or default)
        function addNewTheme() {
            // create a unique id
            const id = `custom_${Date.now()}`;
            // base on active theme vars
            const base = config.themes.find(t => t.id === config.theme) || config.themes[0];
            const newTheme = {
                id,
                name: `Theme ${config.themes.length + 1}`,
                vars: JSON.parse(JSON.stringify(base.vars))
            };
            config.themes.push(newTheme);
            renderThemeControls();
            renderThemeSelect();
            saveData();
        }

        function resetThemesToDefault() {
            if (!confirm('Reset themes to built-in defaults? This will remove custom themes.')) return;
            config.themes = JSON.parse(JSON.stringify(DEFAULT_THEMES));
            if (!config.themes.find(t => t.id === config.theme)) config.theme = config.themes[0].id;
            renderThemeControls();
            renderThemeSelect();
            applyTheme(config.theme);
            saveData();
        }

        // EXPORT / IMPORT functionality
        function exportSettings() {
            try {
                const payload = { config: config, tasks: tasks };
                const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const date = new Date().toISOString().slice(0,10);
                a.download = `dash-settings-${date}.json`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error(e);
                alert('Failed to export settings.');
            }
        }

        function handleImportFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const parsed = JSON.parse(ev.target.result);
                    // Support both payloads: {config, tasks} or simple config object
                    let importedConfig = null;
                    let importedTasks = null;
                    if (parsed && typeof parsed === 'object' && ('config' in parsed || 'themes' in parsed || 'groups' in parsed)) {
                        if (parsed.config) {
                            importedConfig = parsed.config;
                            importedTasks = parsed.tasks || [];
                        } else {
                            // direct config object
                            importedConfig = parsed;
                            importedTasks = parsed.tasks || [];
                        }
                    } else {
                        throw new Error('Invalid settings file format.');
                    }

                    // Basic validation and normalization
                    if (!importedConfig.themes || !Array.isArray(importedConfig.themes) || importedConfig.themes.length === 0) {
                        // fallback to defaults if no themes present
                        importedConfig.themes = JSON.parse(JSON.stringify(DEFAULT_THEMES));
                    } else {
                        // ensure each theme has id and vars
                        importedConfig.themes = importedConfig.themes.map((t, idx) => {
                            if (!t.id) t.id = `imp_${Date.now()}_${idx}`;
                            if (!t.vars) t.vars = JSON.parse(JSON.stringify(DEFAULT_THEMES[0].vars));
                            return t;
                        });
                    }

                    // ensure at least one theme active
                    if (!importedConfig.theme || !importedConfig.themes.find(tt => tt.id === importedConfig.theme)) {
                        importedConfig.theme = importedConfig.themes[0].id;
                    }

                    // Replace current config/tasks with imported ones
                    config = importedConfig;
                    tasks = Array.isArray(importedTasks) ? importedTasks : [];

                    // Persist and apply
                    saveData();
                    applyTheme(config.theme);
                    renderThemeSelect();
                    renderThemeControls();
                    renderWeatherTabs();
                    fetchWeather();
                    renderPanels();
                    renderCalendar();
                    renderTasks();
                    alert('Settings imported successfully.');
                    document.getElementById('settings-modal').classList.remove('active');
                } catch (err) {
                    console.error(err);
                    alert('Failed to import settings: ' + (err.message || err));
                }
            };
            reader.onerror = () => {
                alert('Failed to read file.');
            };
            reader.readAsText(file);
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadData(); updateClock(); setInterval(updateClock, 1000); renderWeatherTabs(); fetchWeather(); renderPanels(); renderCalendar(); renderTasks();
            
            // task mode
            const taskMode = document.getElementById('task-mode');
            const savedMode = localStorage.getItem('dash_v4_task_mode') || 'local';
            taskMode.value = savedMode;
            toggleTaskUI(savedMode);

            taskMode.onchange = (e) => {
                localStorage.setItem('dash_v4_task_mode', e.target.value);
                toggleTaskUI(e.target.value);
            };

            function toggleTaskUI(mode) {
                document.getElementById('local-tasks-ui').style.display = mode === 'local' ? 'block' : 'none';
                document.getElementById('google-tasks-ui').style.display = mode === 'google' ? 'block' : 'none';
            }

            document.getElementById('settings-btn').onclick = openSettings;
            document.getElementById('cancel-settings').onclick = () => document.getElementById('settings-modal').classList.remove('active');
            document.getElementById('save-settings').onclick = saveSettings;
            document.getElementById('add-group-btn').onclick = () => {
                config.groups.push({ title: 'New Group', panel: 'left', links: [] });
                openSettings();
            };
            document.getElementById('prev-month').onclick = () => { currentCalDate.setMonth(currentCalDate.getMonth()-1); renderCalendar(); };
            document.getElementById('next-month').onclick = () => { currentCalDate.setMonth(currentCalDate.getMonth()+1); renderCalendar(); };
            document.getElementById('add-task-btn').onclick = () => {
                const input = document.getElementById('task-input');
                if (input.value.trim()) { tasks.push({ text: input.value.trim(), completed: false }); renderTasks(); saveData(); input.value = ''; }
            };
            document.getElementById('search-box').onkeypress = (e) => {
                if (e.key === 'Enter' && e.target.value.trim()) window.location.href = `https://google.com/search?q=${encodeURIComponent(e.target.value.trim())}`;
            };

            // theme controls
            document.getElementById('add-theme-btn').onclick = addNewTheme;
            document.getElementById('reset-themes-btn').onclick = resetThemesToDefault;
            // when theme-select changes apply immediately
            document.getElementById('theme-select').onchange = (e) => { applyTheme(e.target.value); saveData(); };

            // ensure theme-select is populated on initial load
            renderThemeSelect();

            // import/export event wiring
            document.getElementById('export-settings-btn').onclick = exportSettings;
            const importBtn = document.getElementById('import-settings-btn');
            const importInput = document.getElementById('import-file-input');
            importBtn.onclick = () => importInput.click();
            importInput.onchange = (e) => {
                const f = e.target.files && e.target.files[0];
                if (f) {
                    if (!confirm('Importing will replace your current settings. Continue?')) {
                        importInput.value = '';
                        return;
                    }
                    handleImportFile(f);
                    importInput.value = '';
                }
            };
        });
    </script>
</body>
</html>